# Лабораторная работа №4

* Имя студента: Андрей Соснов
* Группа: P4150
* Дата выполнения задания: 31.03.2025
* Наименование дисциплины: Взаимодействие с базами данных
* Текст задания:
* Описание предметной области:

Предметная область включает в себя генеалогическое дерево, реализованное в веб и мобильном приложениях, которое позволяет пользователю отразить в нём всевозможные родственные связи с другими людьми, а также проследить наследование какого-либо признака (в том числе заболевания, но не только) и рассчитать вероятность проявления этого признака в последующих поколениях.

Приложение подразумевает наличие нескольких моделей (сущностей, классов), которые будут отражать данную предметную область и конкретно будут реализованы в таблицах реляционной базы данных. А именно:

* Люди, которые имеют имена, фотографию, дату рождения, дату смерти, биографические данные и наследуемые признаки.
* Связи, которые имеют тип (родитель-ребенок, муж-жена, брат-сестра и т.п.) и двух персон.
* Наследуемые признаки, которые имеют название и тип наследования.
* Наследование, которое связывает людей и признаки, и содержит информацию о значении признака у конкретного человека и дополнительные заметки.

# Бизнес-правила

## 1. Автоматическое добавление обратных родственных связей

**Описание:**
При добавлении записи об отношении "родитель-ребенок" в таблицу `relationships`, система должна автоматически добавлять обратное отношение "ребенок-родитель" между теми же участниками, но в обратном порядке.

**Обоснование:**
Обеспечивает симметричность родственных связей и избавляет пользователя от необходимости ручного ввода обратных данных.

---

## 2. Контроль дат рождения и смерти

**Описание:**
При добавлении или обновлении информации о человеке:
- Дата смерти не может быть раньше даты рождения.
- Дата рождения не может быть позже текущей даты.

**Обоснование:**
Исключает логические противоречия при вводе биографических данных.

---

## 3. Наследование признаков по родителям

**Описание:**
Если у человека в таблице `inheritance` добавляется наследуемый признак (например, "Диабет"), и этот же признак уже есть у одного из родителей, то в поле `notes` автоматически добавляется информация о том, от кого признак унаследован.

**Обоснование:**
Автоматизирует отслеживание наследуемости признаков и повышает информативность базы данных.



---

## 4. Запрет на дублирование родственных связей

**Описание:**
Между двумя людьми может быть не более одной записи одного и того же типа в таблице `relationships`. Попытки создать дубликаты должны отклоняться.

**Обоснование:**
Исключает логические ошибки и дублирование информации в БД.

---

## 5. Проверка существования признака при добавлении наследования

**Описание:**
При добавлении записи о наследовании признака для человека, необходимо проверить, существует ли такой признак в таблице `traits`.

**Обоснование:**
Предотвращает появление ссылок на несуществующие признаки и обеспечивает целостность данных.

---

## 6. Проверка допустимых значений группы крови

**Описание:**
При добавлении или обновлении признака с названием "Blood Type" в таблицу `inheritance`, значение признака должно быть одним из допустимых: "A", "B", "AB", "O", с возможным указанием резус-фактора ("+" или "-").

**Обоснование:**
Исключает ввод некорректных значений и обеспечивает стандартизацию данных по признаку группы крови.

---

## 7. Запрет на брак с самим собой

**Описание:**
При попытке добавить связь с типом "супруг", `person1_id` и `person2_id` не должны быть одинаковыми.

**Обоснование:**
Исключает логически некорректные брачные связи.

---

## 8. Ограничение на количество родителей

**Описание:**
У одного человека не может быть более двух связей типа "родитель-ребенок", где он выступает в роли ребенка (`person2_id`).

**Обоснование:**
Соответствует биологической модели родства (два родителя).

# Анализ использования базы данных генеалогического дерева

## Общая цель базы данных

База данных реализует хранение информации о людях, их родственных связях и наследуемых признаках в рамках веб- и мобильного приложения. Основные сценарии работы пользователя связаны с построением родословной, отслеживанием генетических признаков, поиском информации о человеке и его родственниках.

---

## Часто используемые сценарии

### 1. Просмотр профиля человека

**Описание:**  
Пользователь открывает карточку человека для просмотра всех данных о нём, включая биографию, фото, жизненные события, родственные связи и наследственные признаки.

**Участвующие таблицы:**
- `people`
- `relationships`
- `inheritance`
- `traits`

**Примеры запросов:**
- Получение полной информации по `person_id`
- Получение всех связей, где человек является `person1_id` или `person2_id`
- Получение признаков через таблицу `inheritance` и `traits`

---

### 2. Построение генеалогического дерева

**Описание:**  
Автоматическое построение дерева: определение родителей, детей, братьев/сестёр.

**Участвующие таблицы:**
- `relationships`
- `people`

**Примеры запросов:**
- Получение родителей: `relationship_type = 'родитель-ребенок'` и `person2_id = ?`
- Получение детей: `relationship_type = 'родитель-ребенок'` и `person1_id = ?`
- Получение сиблингов через общих родителей

---

### 3. Анализ наследуемых признаков

**Описание:**  
Пользователь отслеживает, какие признаки есть у человека, и как они передаются по поколению.

**Участвующие таблицы:**
- `inheritance`
- `traits`
- `people`

**Примеры запросов:**
- Выборка всех людей с определённым `trait_id`
- Список признаков, унаследованных конкретным человеком

---

### 4. Поиск по имени

**Описание:**  
Пользователь ищет человека по имени, фамилии или отчеству.

**Участвующие таблицы:**
- `people`

**Примеры запросов:**
- Поиск по `first_name`, `last_name`, `middle_name` с использованием `ILIKE`
- Объединённый полнотекстовый поиск по ФИО

---

### 5. Просмотр родственных связей

**Описание:**  
Пользователь интересуется отношениями конкретного человека — супруги, дети, родители, братья и сёстры.

**Участвующие таблицы:**
- `relationships`
- `people`

**Примеры запросов:**
- Получение всех связей, связанных с `person_id`
- Фильтрация по `relationship_type`: супруг, родитель-ребенок, брат-сестра

---

## Вывод

Наиболее часто используются следующие объекты:

- Таблицы: `people`, `relationships`, `inheritance`, `traits`
- Поля: `person_id`, `trait_id`, `relationship_type`, `first_name`, `last_name`
- Типы запросов:
  - `SELECT` по ключевым идентификаторам
  - Объединения (`JOIN`) между `people` и `relationships`, `inheritance` и `traits`
  - Поиск по строковым полям (имена)
  - Фильтрация по типу связи или признака

# Описание индексов
## Индекс 1: Быстрый поиск родственных связей

**Цель:**  
Ускорить получение всех связей конкретного человека — как родителя, так и ребёнка (или супруга).

**Таблица:**  
`relationships`

**SQL-запрос создания индекса:**
```sql
CREATE INDEX idx_relationships_person_ids
ON relationships (person1_id, person2_id);
```

**Обоснование:**  
Большинство запросов на построение дерева и просмотр профиля включают условия вида:
```sql
WHERE person1_id = ? OR person2_id = ?
```
Этот составной индекс улучшит время выполнения таких запросов за счёт индексного сканирования.

---

## Индекс 2: Быстрый поиск по ФИО

**Цель:**  
Ускорить поиск людей по имени, отчеству или фамилии.

**Таблица:**  
`people`

**SQL-запрос создания индекса:**
```sql
CREATE INDEX idx_people_name_search
ON people (LOWER(first_name), LOWER(last_name), LOWER(middle_name));
```

**Обоснование:**  
Поскольку поиск осуществляется с использованием `ILIKE`, необходимо привести поля к нижнему регистру. Индекс на `LOWER(...)` позволяет использовать его при запросах вида:
```sql
SELECT * FROM people
WHERE LOWER(first_name) ILIKE 'alex%'
```
Такой индекс значительно ускорит работу формы поиска в приложении.

---

